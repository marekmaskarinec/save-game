import (
        "window.um"; "rect.um"; "th.um"; "canvas.um"; "utf8.um"; "image.um"
        "../../tophat.dat/d_font.um"; "../../tophat.dat/d_util.um"; "../../tophat.dat/d_pfx.um"
)

var (
        mainFont: d_font.Font
        ninepatchImg: image.Image
        boru: image.Image
        dialogMessage: str
        dialogCursor: int
        appearTimer: real
        messageLen: int
)

fn dialogSetup() {
        dialogMessage = "古池や蛙飛び込む水の音\nふるいけやかわずとびこむみずのおと\nThis is a test message\ntest\ntest\ntest\ntest"
        messageLen = utf8.realLength(dialogMessage)
        ninepatchImg = image.load(d_pfx.pfx()+"../ninepatch/medium.png")
        dialogCursor = 0
        appearTimer = 0
}

fn sliceUtf8(s: str, size: int): str {
        ofs := 0
        for size > 0 && ofs < len(s) {
                rune := utf8.getNextRune(s, ofs)
                ofs += rune.size()
                size -= 1
        }
        return slice(s, 0, ofs)
}

fn getBox(): rect.Rect {
        boxSize := mainFont.measure(dialogMessage)
        boxSize.x += 16
        boxSize.y += 16
        box := rect.Rect{60, 60, boxSize.x, boxSize.y}
        return box
}

fn dialogDraw() {
        if dialogCursor > messageLen {
                dialogCursor = messageLen
        }
        msg := sliceUtf8(dialogMessage, dialogCursor)
        if msg == "" {
                return
        }

        d_util.drawRectNinepatch(ninepatchImg, rect.Rect{24, 0, 24, 24}, rect.Rect{8, 8, 8, 8}, getBox())
        mainFont.draw(msg, th.Vf2{68, 68}, th.white)
}

fn main() {
        window.setup("title", 640, 480)
        screen := rect.mk(0, 0, 640, 480)
        mainFont = d_font.loadFont("data/font_mono.ttf", 16)
        boru = image.load(d_pfx.pfx()+"boru.png")

        dialogSetup()

        for window.cycle(screen) {
                canvas.drawRect(th.black, rect.Rect{0, 0, 640, 640})
                appearTimer += th.delta/1000.0;
                if appearTimer > 0.1 {
                        dialogCursor += 1
                        appearTimer = 0
                }
                boru.draw(th.Transform{p: th.Vf2{60-10, 60+120}, s: th.Vf2{1, 1}})
                dialogDraw()
        }
}