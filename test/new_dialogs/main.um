import (
  "window.um"
  "rect.um"
  "th.um"
  "canvas.um"
  "input.um"
  th_font = "font.um"
)

fn wrapText(font: ^th_font.Font, text: str, boundary: real): []str {
  result := []str{}
  lastIndex := 0
  shift := 0.0

  for i, chr in text {
    if (shift+font.measure(""+chr).x) > boundary {
      shift = 0
      result = append(result, slice(text, lastIndex, i))
      lastIndex = i
    }
    shift += font.measure(""+chr).x
  }
  result = append(result, slice(text, lastIndex))

  return result
}

fn main() {
  window.setup("New dialogs", 800, 600) 
  
  font := th_font.load("data/font/monospace.ttf", 16)
  screen := rect.mk(0, 0, 800, 600)
  boundary := 100.0

  for window.cycle(screen) {
    boundary = input.getMousePos().x
    lines := wrapText(&font, "Lorem ipsum dolor sit amet. Hello world! Now this is a story all about how my life got turned upside down.", boundary)

    for i, line in lines {
      font.draw(line, th.Vf2{0, i*font.measure(" ").y}, th.black)
    }

    canvas.drawLine(th.red, th.Vf2{boundary, 0}, th.Vf2{boundary, len(lines)*font.measure(" ").y}, 1)
  }
}